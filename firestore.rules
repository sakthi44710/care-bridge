rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection - users can read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Documents collection - users can only access their own documents
    match /documents/{documentId} {
      allow read, write: if request.auth != null
        && resource == null || resource.data.user_id == request.auth.uid;
      allow create: if request.auth != null
        && request.resource.data.user_id == request.auth.uid;
    }

    // Conversations collection - users can only access their own conversations
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null
        && resource == null || resource.data.user_id == request.auth.uid;
      allow create: if request.auth != null
        && request.resource.data.user_id == request.auth.uid;

      // Messages subcollection - accessible if parent conversation is accessible
      match /messages/{messageId} {
        allow read, write: if request.auth != null
          && get(/databases/$(database)/documents/conversations/$(conversationId)).data.user_id == request.auth.uid;
      }
    }

    // Health records - users can only access their own records
    match /health_records/{recordId} {
      allow read, write: if request.auth != null
        && resource == null || resource.data.user_id == request.auth.uid;
      allow create: if request.auth != null
        && request.resource.data.user_id == request.auth.uid;
    }

    // Blockchain audits - users can read their own audit records
    match /blockchain_audits/{auditId} {
      allow read: if request.auth != null
        && resource.data.user_id == request.auth.uid;
      allow create: if request.auth != null
        && request.resource.data.user_id == request.auth.uid;
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
